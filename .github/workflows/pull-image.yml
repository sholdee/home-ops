name: Verify Docker image

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-author:
    if: startsWith(github.event.pull_request.title, 'Update') && (contains(github.event.pull_request.title, 'Docker tag') || contains(github.event.pull_request.title, 'Docker digest'))
    runs-on: ARM64
    outputs:
      matched: ${{ steps.check_author.outputs.matched }}
    steps:
      - name: Check PR Author
        id: check_author
        run: |
          AUTHORIZED_USERS=("sholdee" "pull-bunyan[bot]")
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          
          if [[ " ${AUTHORIZED_USERS[@]} " =~ " $PR_AUTHOR " ]]; then
            echo "matched=true" >> $GITHUB_OUTPUT
            echo "✅ Authorized user: $PR_AUTHOR"
          else
            echo "matched=false" >> $GITHUB_OUTPUT
            echo "❌ Unauthorized user: $PR_AUTHOR"
          fi

  verify-image-pull:
    needs: check-author
    if: needs.check-author.outputs.matched == 'true'
    runs-on: ARM64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Extract Image, Tag, and Digest from PR Diff
        id: extract_image_tag_digest
        env:
          PR_NUMBER: ${{ github.event.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/extract_image_info.py || { echo "❌ Script failed!"; exit 1; }

      - name: Attempt to pull image and verify platform
        id: pull_image
        run: |
          : > pull_results.txt
          PULL_FAILED=0
  
          IMAGE_FULL="${IMAGE}:${TAG}"
          [ -n "${DIGEST:-}" ] && IMAGE_FULL="${IMAGE}@${DIGEST}"
  
          echo "Pulling image for linux/arm64: $IMAGE_FULL"
          PULL_STATUS="❌"
          PLATFORM_STATUS="—"
  
          if sudo crictl --debug pull "$IMAGE_FULL"; then
            PULL_STATUS="✅"
            # Inspect the pulled image to verify OS/arch
            INSPECT_JSON="$(sudo crictl inspecti -o json "$IMAGE_FULL" || true)"
            if [ -n "$INSPECT_JSON" ]; then
              ARCH="$(printf '%s' "$INSPECT_JSON" | jq -r '.info.imageSpec.architecture // .imageSpec.architecture // empty')"
              OS="$(printf '%s' "$INSPECT_JSON" | jq -r '.info.imageSpec.os           // .imageSpec.os           // empty')"
  
              if [ "$ARCH" = "arm64" ] && [ "$OS" = "linux" ]; then
                PLATFORM_STATUS="✅"
              else
                PLATFORM_STATUS="❌"
                echo "Platform mismatch: expected linux/arm64, got ${OS:-unknown}/${ARCH:-unknown}"
                PULL_FAILED=1
              fi
            else
              PLATFORM_STATUS="❌"
              echo "Failed to inspect image metadata for $IMAGE_FULL"
              PULL_FAILED=1
            fi
          else
            echo "Failed to pull $IMAGE_FULL"
            PULL_FAILED=1
          fi
  
          # Write a TSV line: Pulled <tab> Platform <tab> Image
          printf "%s\t%s\t%s\n" "$PULL_STATUS" "$PLATFORM_STATUS" "$IMAGE_FULL" >> pull_results.txt
  
          if [ "$PULL_FAILED" -ne 0 ]; then
            exit 1
          fi
  
      - name: Format Image Pull Status
        id: format_image_pull_status
        run: |
          {
            echo "IMAGE_PULL_COMMENT<<EOF"
            echo "| Pulled | Platform | Image |"
            echo "|--------|----------|-------|"
            while IFS=$'\t' read -r PULLED PLATFORM IMG; do
              echo "| $PULLED | $PLATFORM | \`$IMG\` |"
            done < pull_results.txt
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Generate Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

      - name: Add Comment
        continue-on-error: true
        uses: mshick/add-pr-comment@v2
        with:
          repo-token: "${{ steps.app-token.outputs.token }}"
          message-id: "${{ github.event.pull_request.number }}/docker-verify"
          message-failure: "Error adding comment"
          message: |
            ${{ env.IMAGE_PULL_COMMENT }}
