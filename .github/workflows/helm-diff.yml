name: Helm App Diff

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-author:
    if: startsWith(github.event.pull_request.title, 'Update Helm release')
    runs-on: ubuntu-latest
    outputs:
      matched: ${{ steps.check_author.outputs.matched }}
    steps:
      - name: Check PR Author
        id: check_author
        run: |
          AUTHORIZED_USERS=("sholdee" "pull-bunyan[bot]")
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          
          if [[ " ${AUTHORIZED_USERS[@]} " =~ " $PR_AUTHOR " ]]; then
            echo "matched=true" >> $GITHUB_OUTPUT
            echo "✅ Authorized user: $PR_AUTHOR"
          else
            echo "matched=false" >> $GITHUB_OUTPUT
            echo "❌ Unauthorized user: $PR_AUTHOR"
          fi

  helm-diff:
    needs: check-author
    if: needs.check-author.outputs.matched == 'true'
    runs-on: ubuntu-latest
    outputs:
      ARTIFACT_NAME: ${{ steps.set-artifact-name.outputs.ARTIFACT_NAME }}
    steps:
      - name: Generate Unique Artifact Name
        id: set-artifact-name
        run: |
          ARTIFACT_NAME="helm-diff-$(date +%s)"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Fetch base branch for comparison
        run: git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1

      - name: Install Dependencies
        run: |
            sudo apt-get update
            sudo apt-get install -y wget curl jq

      - name: Install yq (Latest Version)
        run: |
            YQ_VERSION=$(curl -sL https://api.github.com/repos/mikefarah/yq/releases/latest | jq -r ".tag_name" | sed 's/v//')
            ARCH=$(uname -m)
            
            if [ "$ARCH" = "x86_64" ]; then
                PLATFORM="amd64"
            elif [ "$ARCH" = "aarch64" ]; then
                PLATFORM="arm64"
            else
                PLATFORM="386"
            fi
            
            wget "https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_${PLATFORM}" -O /usr/local/bin/yq
            chmod +x /usr/local/bin/yq
            yq --version
            curl -sSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Find Modified Helm Applications
        run: |
            FILE="apps/argocd-conf/argocd-apps.yml"
            
            # Extract list of modified targetRevision values
            CHANGED_VERSIONS=$(git diff --unified=0 --no-color origin/${{ github.event.pull_request.base.ref }} -- "$FILE" | grep -E "^\+\s+targetRevision:" | awk '{$NF=$NF};1' | awk '{print $NF}' | tr -d '[:space:]' || true)
            
            if [ -z "$CHANGED_VERSIONS" ]; then
                  echo "No Helm chart updates detected."
                  exit 0
            fi
            
            echo "Modified Versions: $CHANGED_VERSIONS"
            
            echo "## Helm Chart Diff" > diff.txt
            
            # Loop over changed targetRevision versions
            for REV in $CHANGED_VERSIONS; do
                  # Extract all app names that now have this targetRevision
                  APP_NAMES=$(yq e ". | select(.kind == \"Application\" and .spec.source.targetRevision == \"$REV\") | .metadata.name" "$FILE")
                  
                  # Loop through each app and check if it actually changed
                  for APP_NAME in $APP_NAMES; do
                        OLD_VERSION=$(git show origin/${{ github.event.pull_request.base.ref }}:"$FILE" | yq e "select(.metadata.name == \"$APP_NAME\") | .spec.source.targetRevision" -)
                        NEW_VERSION=$(yq e "select(.metadata.name == \"$APP_NAME\") | .spec.source.targetRevision" "$FILE")

                        # Skip apps where targetRevision didn't actually change
                        if [[ "$OLD_VERSION" == "$NEW_VERSION" || -z "$NEW_VERSION" ]]; then
                              continue
                        fi
                        
                        CHART_NAME=$(yq e "select(.metadata.name == \"$APP_NAME\") | .spec.source.chart" "$FILE")
                        REPO_URL=$(yq e "select(.metadata.name == \"$APP_NAME\") | .spec.source.repoURL" "$FILE")
                        NAMESPACE=$(yq e "select(.metadata.name == \"$APP_NAME\") | .spec.destination.namespace" "$FILE")

                        echo "Processing $APP_NAME: $OLD_VERSION → $NEW_VERSION"
                        
                        git show origin/${{ github.event.pull_request.base.ref }}:"$FILE" | yq e "select(.metadata.name == \"$APP_NAME\") | .spec.source.helm.valuesObject" - > old-values.yaml
                        yq e "select(.metadata.name == \"$APP_NAME\") | .spec.source.helm.valuesObject" "$FILE" > new-values.yaml
                        
                        REPO_NAME=$(echo "$REPO_URL" | awk -F/ '{print $NF}')
                        helm repo add "$REPO_NAME" "$REPO_URL"
                        helm repo update
                        
                        echo "Checking available versions for $CHART_NAME..."
                        helm search repo "$REPO_NAME/$CHART_NAME" --versions
                        
                        if ! helm search repo "$REPO_NAME/$CHART_NAME" --versions | grep -q "$OLD_VERSION"; then
                              echo "Error: Chart $CHART_NAME version $OLD_VERSION not found in repo $REPO_NAME. Skipping..."
                              continue
                        fi
                        
                        if ! helm search repo "$REPO_NAME/$CHART_NAME" --versions | grep -q "$NEW_VERSION"; then
                              echo "Error: Chart $CHART_NAME version $NEW_VERSION not found in repo $REPO_NAME. Skipping..."
                              continue
                        fi
                        
                        echo "Rendering old Helm template..."
                        helm template "$APP_NAME" "$REPO_NAME/$CHART_NAME" --version "$OLD_VERSION" --namespace "$NAMESPACE" -f old-values.yaml > old.yaml || { echo "Helm template failed for old version"; continue; }
                        
                        echo "Rendering new Helm template..."
                        helm template "$APP_NAME" "$REPO_NAME/$CHART_NAME" --version "$NEW_VERSION" --namespace "$NAMESPACE" -f new-values.yaml > new.yaml || { echo "Helm template failed for new version"; continue; }

                        # Process in chunks and stream the diff using git diff
                        echo "Formatting and diffing manifests..."
                        yq eval old.yaml | split -l 10000 - old_chunk_
                        yq eval new.yaml | split -l 10000 - new_chunk_
                        
                        # For first chunk, use normal git diff
                        first_chunk=true
                        # Loop through chunks and diff them using git diff
                        for old_chunk in old_chunk_*; do
                          chunk_num=${old_chunk#old_chunk_}
                          new_chunk="new_chunk_$chunk_num"
                          
                          if [ -f "$new_chunk" ]; then
                            echo "Processing chunk $chunk_num..." 
                            if [ "$first_chunk" = true ]; then
                              git diff --no-index --text "$old_chunk" "$new_chunk" >> diff.txt || true
                              first_chunk=false
                            else
                              # For subsequent chunks, use --no-prefix to avoid headers
                              git diff --no-index --text --no-prefix "$old_chunk" "$new_chunk" >> diff.txt || true
                            fi
                          fi
                        done
                  done
            done

      - name: Read Helm Diff Output
        id: diff
        run: |
            if [ -s diff.txt ]; then
                echo "diff<<EOF" >> $GITHUB_ENV
                cat diff.txt >> $GITHUB_ENV
                echo "EOF" >> $GITHUB_ENV
            fi

      - name: Generate Token
        if: ${{ env.diff != '' }}
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

      - name: Add Comment
        if: ${{ env.diff != '' }}
        continue-on-error: true
        uses: mshick/add-pr-comment@v2
        with:
          repo-token: "${{ steps.app-token.outputs.token }}"
          message-id: "${{ github.event.pull_request.number }}/helm-diff"
          message-failure: Diff was not successful
          message: |
            ```diff
            ${{ env.diff }}
            ```

      - name: Upload Helm Diff as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: diff.txt
          retention-days: 7

  verify-new-images:
    needs: helm-diff
    runs-on: ARM64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Helm Diff
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.helm-diff.outputs.ARTIFACT_NAME }}

      - name: Debug Helm Diff Contents
        run: |
          echo "===== DIFF.TXT CONTENTS ====="
          cat diff.txt || echo "diff.txt is empty!"

      - name: Extract Image Updates from Helm Diff
        id: extract_helm_images
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DIFF_TXT_PATH: diff.txt
        run: |
          python .github/scripts/extract_image_info.py || { echo "❌ Script failed!"; exit 1; }

      - name: Attempt to Pull Extracted Images
        id: pull_helm_images
        run: |
          if [ -z "$IMAGE_COUNT" ] || [ "$IMAGE_COUNT" -eq 0 ]; then
            echo "No images detected for pulling."
            exit 0
          fi
          
          for i in $(seq 0 $((IMAGE_COUNT - 1))); do
              IMAGE_VAR="IMAGE_$i"
              TAG_VAR="TAG_$i"
              DIGEST_VAR="DIGEST_$i"
              
              IMAGE_FULL="${!IMAGE_VAR}:${!TAG_VAR}"
              [ -n "${!DIGEST_VAR}" ] && IMAGE_FULL="${!IMAGE_VAR}@${!DIGEST_VAR}"
              
              echo "Pulling image: $IMAGE_FULL"
              sudo crictl --debug pull "$IMAGE_FULL" || exit 1
          done

      - name: Add `donotmerge` Label if any Pull Fails
        if: failure()
        run: |
          gh pr edit ${{ github.event.number }} --add-label "donotmerge"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove `donotmerge` Label if all Pulls Succeed
        if: success()
        run: |
          gh pr edit ${{ github.event.number }} --remove-label "donotmerge"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
