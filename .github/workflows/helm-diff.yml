---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Helm App Diff

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    paths:
      - '**/kustomization.yaml'
      - 'apps/argocd/manifests/apps.yaml'
      - 'apps/argocd/manifests/cilium-preflight.yaml'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-author:
    if: >
      startsWith(github.event.pull_request.title, 'Update Helm release') || startsWith(github.event.pull_request.title, '[helm-diff]')
      || (
        startsWith(github.event.pull_request.title, 'Update')
        && (
          contains(github.event.pull_request.title, 'Docker tag')
          || contains(github.event.pull_request.title, 'Docker digest')
        )
      )

    runs-on: ubuntu-latest
    outputs:
      matched: ${{ steps.check_author.outputs.matched }}
    steps:
      - name: Check PR Author
        id: check_author
        run: |
          AUTHORIZED_USERS=("sholdee" "pull-bunyan[bot]")
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          
          if [[ " ${AUTHORIZED_USERS[@]} " =~ " $PR_AUTHOR " ]]; then
            echo "matched=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Authorized user: $PR_AUTHOR"
          else
            echo "matched=false" >> $GITHUB_OUTPUT
            echo "‚ùå Unauthorized user: $PR_AUTHOR"
          fi

  helm-diff:
    needs: check-author
    if: needs.check-author.outputs.matched == 'true'
    runs-on: ubuntu-latest
    outputs:
      HAS_DIFF: ${{ steps.read-diff.outputs.HAS_DIFF }}
      ARTIFACT_NAME: ${{ steps.set-artifact-name.outputs.ARTIFACT_NAME }}
    steps:
      - name: Generate Unique Artifact Name
        id: set-artifact-name
        run: |
          ARTIFACT_NAME="helm-diff-$(date +%s)"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Fetch base branch for comparison
        run: git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Install base CLI deps
        run: |
          MISSING=()
          TOOLS=(curl jq)

          for tool in "${TOOLS[@]}"; do
            if ! command -v "$tool" >/dev/null 2>&1; then
              MISSING+=("$tool")
            fi
          done

          if [ ${#MISSING[@]} -ne 0 ]; then
            echo "Installing missing packages: ${MISSING[*]}"
            sudo apt-get update
            sudo apt-get install -y "${MISSING[@]}"
          else
            echo "All required CLI tools already installed: ${TOOLS[*]}"
          fi

      - name: Install kustomize
        run: |
          VERSION="5.7.0"
          ARCH="$(uname -m)"
          case "$ARCH" in
            x86_64)
              PLATFORM="amd64"
              ;;
            aarch64 | arm64)
              PLATFORM="arm64"
              ;;
            *)
              PLATFORM="386"
              echo "‚ö†Ô∏è Unrecognized architecture '$ARCH', defaulting to linux_${PLATFORM}"
              ;;
          esac

          echo "PLATFORM=$PLATFORM" >> "$GITHUB_ENV"

          echo "Installing kustomize v${VERSION} for linux_${PLATFORM} (uname -m=${ARCH})..."

          curl -sSLo kustomize.tar.gz \
            "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv${VERSION}/kustomize_v${VERSION}_linux_${PLATFORM}.tar.gz"

          tar -xzf kustomize.tar.gz
          sudo mv kustomize /usr/local/bin/kustomize
          rm kustomize.tar.gz

          echo "kustomize version:"
          kustomize version

      - name: Check yq presence/version
        id: check-yq
        run: |
          MIN_MAJOR=4
          NEED_INSTALL=0

          if command -v yq >/dev/null 2>&1; then
            CURRENT_VER="$(yq --version 2>/dev/null || true)"
            echo "Found yq: $CURRENT_VER"

            # Extract major version from e.g. "yq (...) version v4.48.1"
            CURRENT_MAJOR="$(printf '%s\n' "$CURRENT_VER" | sed -n 's/.*version v\([0-9]\+\).*/\1/p')"

            if [ -z "$CURRENT_MAJOR" ] || [ "$CURRENT_MAJOR" -lt "$MIN_MAJOR" ]; then
              echo "Existing yq major '${CURRENT_MAJOR:-unknown}' is < ${MIN_MAJOR}, will install newer yq."
              NEED_INSTALL=1
            else
              echo "Existing yq is v$CURRENT_MAJOR (>= v${MIN_MAJOR}); will reuse."
            fi
          else
            echo "yq not found; will install."
            NEED_INSTALL=1
          fi

          if [ "$NEED_INSTALL" -eq 1 ]; then
            echo "need_install=true" >> "$GITHUB_OUTPUT"
          else
            echo "need_install=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine yq version
        id: yq-version
        if: steps.check-yq.outputs.need_install == 'true'
        run: |
          YQ_VERSION=$(curl -sL https://api.github.com/repos/mikefarah/yq/releases/latest \
            | jq -r '.tag_name')  # keep the leading "v"
          echo "YQ_VERSION=$YQ_VERSION" >> "$GITHUB_ENV"
          echo "version=$YQ_VERSION" >> "$GITHUB_OUTPUT"

      - name: Install yq
        if: steps.check-yq.outputs.need_install == 'true'
        env:
          YQ_VERSION: ${{ steps.yq-version.outputs.version }}
        run: |
          echo "Installing yq ${YQ_VERSION}..."
          curl -sSL "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_${PLATFORM}" \
            -o yq
          sudo mv yq /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

          echo "yq after install:"
          yq --version

      - name: Prepare base worktree
        run: |
          BASE_WORKTREE_DIR="../base-worktree"
          echo "BASE_WORKTREE_DIR=$BASE_WORKTREE_DIR" >> "$GITHUB_ENV"
      
          if [ ! -d "$BASE_WORKTREE_DIR" ]; then
            echo "üìÇ Creating base worktree at $BASE_WORKTREE_DIR from origin/${{ github.event.pull_request.base.ref }}..."
            git worktree add "$BASE_WORKTREE_DIR" "origin/${{ github.event.pull_request.base.ref }}"
          fi

      - name: Process Helm diffs
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          BASE_WORKTREE_DIR: ${{ env.BASE_WORKTREE_DIR }}
        run: bash "$BASE_WORKTREE_DIR/.github/scripts/helm_diff.sh"

      - name: Read Helm Diff Output
        id: read-diff
        run: |
          if [ -s diff.txt ]; then
            echo "HAS_DIFF=true" >> $GITHUB_OUTPUT
          else
            echo "HAS_DIFF=false" >> $GITHUB_OUTPUT
            echo "No differences detected." > diff.txt
          fi

      - name: Prepare Diff Snippet
        id: prepare-diff
        run: |
          MAX_BYTES=65000
          if [ -s diff.txt ]; then
            if [ "$(wc -c < diff.txt)" -gt "$MAX_BYTES" ]; then
              # Truncate by bytes and clean up any invalid UTF-8 sequences
              # caused by cutting in the middle of a multibyte char.
              head -c "$MAX_BYTES" diff.txt | iconv -c -f utf-8 -t utf-8 > diff_snippet.txt

              printf "\n\n####### TRUNCATED -- see artifact for full diff #######\n" >> diff_snippet.txt
            else
              cp diff.txt diff_snippet.txt
            fi
          else
            echo "No differences detected." > diff_snippet.txt
          fi

          {
            echo "DIFF_SNIPPET<<EOF"
            cat diff_snippet.txt
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Generate Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

      - name: Add Comment
        continue-on-error: true
        uses: mshick/add-pr-comment@v2
        with:
          repo-token: "${{ steps.app-token.outputs.token }}"
          message-id: "${{ github.event.pull_request.number }}/helm-diff"
          message-failure: Diff was not successful
          message: |
            ```diff
            ${{ env.DIFF_SNIPPET }}
            ```
            - [Download Artifact](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Upload Helm Diff as Artifact
        if: steps.read-diff.outputs.HAS_DIFF == 'true'
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: diff.txt
          retention-days: 30

  verify-new-images:
    needs: helm-diff
    if: needs.helm-diff.outputs.HAS_DIFF == 'true'
    runs-on: ARM64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download Helm Diff
        uses: actions/download-artifact@v6
        with:
          name: ${{ needs.helm-diff.outputs.ARTIFACT_NAME }}

      - name: Extract Image Updates from Helm Diff
        id: extract_helm_images
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DIFF_TXT_PATH: diff.txt
        run: |
          python .github/scripts/extract_image_info.py || { echo "‚ùå Script failed!"; exit 1; }

      - name: Attempt to Pull Extracted Images and Verify Platform
        id: pull_helm_images
        run: |
          : > pull_results.txt
          PULL_FAILED=0
          
          if [ -z "${IMAGE_COUNT:-}" ] || [ "${IMAGE_COUNT:-0}" -eq 0 ]; then
            echo "No images detected for pulling."
            exit 0
          fi
          
          for i in $(seq 0 $((IMAGE_COUNT - 1))); do
            IMAGE_VAR="IMAGE_$i"
            TAG_VAR="TAG_$i"
            DIGEST_VAR="DIGEST_$i"
            
            declare -n IMG="$IMAGE_VAR" TAG="$TAG_VAR" DIG="$DIGEST_VAR"
            IMAGE_FULL="${IMG:-}:${TAG:-}"
            [ -n "${DIG-}" ] && IMAGE_FULL="${IMG}@${DIG}"
            
            echo "Pulling image: $IMAGE_FULL"
            
            PULL_STATUS="‚ùå"
            PLATFORM_STATUS="‚Äî"
            
            if sudo crictl --debug pull "$IMAGE_FULL"; then
              PULL_STATUS="‚úÖ"
              
              # Inspect pulled image -> verify linux/arm64
              INSPECT_JSON="$(sudo crictl inspecti -o json "$IMAGE_FULL" || true)"
              if [ -n "$INSPECT_JSON" ]; then
                ARCH="$(printf '%s' "$INSPECT_JSON" | jq -r '.info.imageSpec.architecture // .imageSpec.architecture // empty')"
                OS="$(printf '%s' "$INSPECT_JSON"   | jq -r '.info.imageSpec.os           // .imageSpec.os           // empty')"
                
                if [ "$ARCH" = "arm64" ] && [ "$OS" = "linux" ]; then
                  PLATFORM_STATUS="‚úÖ"
                else
                  PLATFORM_STATUS="‚ùå"
                  echo "Platform mismatch for $IMAGE_FULL: expected linux/arm64, got ${OS:-unknown}/${ARCH:-unknown}"
                  PULL_FAILED=1
                fi
              else
                PLATFORM_STATUS="‚ùå"
                echo "Failed to inspect image metadata for $IMAGE_FULL"
                PULL_FAILED=1
              fi
            else
              echo "Failed to pull $IMAGE_FULL"
              PULL_FAILED=1
            fi
            
            # TSV: Pulled <tab> Platform <tab> Image
            printf "%s\t%s\t%s\n" "$PULL_STATUS" "$PLATFORM_STATUS" "$IMAGE_FULL" >> pull_results.txt
          done
          
          if [ "$PULL_FAILED" -ne 0 ]; then
            exit 1
          fi

      - name: Format Image Pull Status
        id: format_image_pull_status
        if: always()
        run: |
          if [ ! -s pull_results.txt ]; then
            echo "No new images were found. Skipping PR comment."
            exit 0
          fi
          
          {
            echo "IMAGE_PULL_COMMENT<<EOF"
            echo "| Pulled | Platform | Image |"
            echo "|--------|----------|-------|"
            while IFS=$'\t' read -r PULLED PLATFORM IMG; do
              echo "| $PULLED | $PLATFORM | \`$IMG\` |"
            done < pull_results.txt
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Generate Token
        if: always() && env.IMAGE_PULL_COMMENT != ''
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: "${{ secrets.BOT_APP_ID }}"
          private-key: "${{ secrets.BOT_APP_PRIVATE_KEY }}"

      - name: Add Comment
        if: always() && env.IMAGE_PULL_COMMENT != ''
        continue-on-error: true
        uses: mshick/add-pr-comment@v2
        with:
          repo-token: "${{ steps.app-token.outputs.token }}"
          message-id: "${{ github.event.pull_request.number }}/pull-results"
          message: |
            ${{ env.IMAGE_PULL_COMMENT }}
