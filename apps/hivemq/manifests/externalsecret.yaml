---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: hivemq-file-rbac-credentials
  namespace: hivemq
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: hivemq-file-rbac-credentials
    template:
      engineVersion: v2
      type: Opaque
      data:
        credentials.xml: |-
          <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
          <file-rbac>
            <users>
              <user>
                <name>hass</name>
                <password>{{ .HASS_PWD }}</password>
                <roles>
                  <id>superuser</id>
                </roles>
              </user>
              <user>
                <name>zwave</name>
                <password>{{ .ZWAVE_PWD }}</password>
                <roles>
                  <id>zwave</id>
                </roles>
              </user>
              <user>
                <name>venstar</name>
                <password>{{ .VENSTAR_PWD }}</password>
                <roles>
                  <id>venstar</id>
                </roles>
              </user>
              <user>
                <name>raspi</name>
                <password>{{ .RASPI_PWD }}</password>
                <roles>
                  <id>raspi</id>
                </roles>
              </user>
              <user>
                <name>sei12</name>
                <password>{{ .SEI12_PWD }}</password>
                <roles>
                  <id>sei12</id>
                </roles>
              </user>
              <user>
                <name>nas</name>
                <password>{{ .NAS_PWD }}</password>
                <roles>
                  <id>nas</id>
                </roles>
              </user>
              <user>
                <name>mikrotik</name>
                <password>{{ .MIKROTIK_PWD }}</password>
                <roles>
                  <id>mikrotik</id>
                </roles>
              </user>
              <user>
                <name>read</name>
                <password>{{ .READ_PWD }}</password>
                <roles>
                  <id>read-only</id>
                </roles>
              </user>
            </users>
            <roles>
              <role>
                <id>superuser</id>
                <permissions>
                  <permission>
                    <topic>#</topic>
                  </permission>
                </permissions>
              </role>
              <role>
                <id>zwave</id>
                <permissions>
                  <permission>
                    <topic>home/nodes/zwave/#</topic>
                  </permission>
                  <permission>
                    <topic>homeassistant/#</topic>
                  </permission>
                </permissions>
              </role>
              <role>
                <id>venstar</id>
                <permissions>
                  <permission>
                    <topic>home/nodes/venstar/#</topic>
                  </permission>
                  <permission>
                    <topic>/status/mqtt_venstar_bridge</topic>
                  </permission>
                </permissions>
              </role>
              <role>
                <id>raspi</id>
                <permissions>
                  <permission>
                    <topic>home/nodes/#</topic>
                  </permission>
                  <permission>
                    <topic>homeassistant/#</topic>
                  </permission>
                </permissions>
              </role>
              <role>
                <id>sei12</id>
                <permissions>
                  <permission>
                    <topic>linux/sei12/#</topic>
                  </permission>
                  <permission>
                    <topic>homeassistant/sensor/linux/#</topic>
                  </permission>
                </permissions>
              </role>
              <role>
                <id>nas</id>
                <permissions>
                  <permission>
                    <topic>linux/nas/#</topic>
                  </permission>
                  <permission>
                    <topic>homeassistant/sensor/linux/#</topic>
                  </permission>
                </permissions>
              </role>
              <role>
                <id>mikrotik</id>
                <permissions>
                  <permission>
                    <topic>home/nodes/mikrotik/#</topic>
                  </permission>
                  <permission>
                    <topic>homeassistant/sensor/#</topic>
                  </permission>
                </permissions>
              </role>
              <role>
                <id>read-only</id>
                <permissions>
                  <permission>
                    <topic>#</topic>
                    <activity>SUBSCRIBE</activity>
                  </permission>
                </permissions>
              </role>
            </roles>
          </file-rbac>
  dataFrom:
    - extract:
        key: hivemq
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: hivemq-configuration-hivemq-platform
  namespace: hivemq
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: hivemq-configuration-hivemq-platform
    template:
      engineVersion: v2
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: hivemq
      data:
        config.xml: |-
          <?xml version="1.0"?>
          <hivemq xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="config.xsd">
            <listeners>
              <tcp-listener>
                <port>1883</port>
                <bind-address>0.0.0.0</bind-address>
              </tcp-listener>
              <tcp-listener>
                <port>8883</port>
                <bind-address>0.0.0.0</bind-address>
                <!-- Enable PROXY protocol from upstream L4 proxy/load balancer -->
                <proxy-protocol>true</proxy-protocol>
              </tcp-listener>
            </listeners>
            <cluster>
              <transport>
                <tcp>
                  <bind-address>0.0.0.0</bind-address>
                  <bind-port>7000</bind-port>
                </tcp>
              </transport>
              <enabled>true</enabled>
              <discovery>
                <extension/>
              </discovery>
            </cluster>
            <health-api>
              <enabled>true</enabled>
              <listeners>
                <http>
                  <port>8889</port>
                  <bind-address>0.0.0.0</bind-address>
                </http>
              </listeners>
            </health-api>
            <control-center>
              <listeners>
                <http>
                  <port>8080</port>
                  <bind-address>0.0.0.0</bind-address>
                </http>
              </listeners>
              <default-user-enabled>false</default-user-enabled>
              <users>
                <user>
                  <name>admin</name>
                  <password>{{ (printf "admin%s" .ADMINUI_PWD) | sha256sum }}</password>
                </user>
              </users>
            </control-center>
          </hivemq>
        tracing.xml: |-
          <?xml version="1.0" encoding="UTF-8" ?>
          <tracing xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="tracing.xsd">
            <context-propagation>
              <outbound-context-propagation>
                <enabled>false</enabled>
              </outbound-context-propagation>
            </context-propagation>
            <sampling>
              <publish-sampling>
                <enabled>true</enabled>
              </publish-sampling>
            </sampling>
          </tracing>
  dataFrom:
    - extract:
        key: hivemq
