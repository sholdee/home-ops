apiVersion: v1
kind: ConfigMap
metadata:
  name: wg-healthcheck
  namespace: wireguard
data:
  healthcheck.sh: |
    #!/bin/sh
    
    is_link_up() {
        [ -f "/sys/class/net/$1/carrier" ] && [ "$(cat "/sys/class/net/$1/carrier")" = "1" ]
    }
    
    return_status_code() {
        if is_link_up "$1"; then
            echo "200 OK"
        else
            echo "503 KO"
        fi
    }
    
    create_response() {
        status_code=$(return_status_code "$1")
        echo -e "HTTP/1.1 ${status_code%% *}\r\nContent-Type: text/plain\r\nConnection: close\r\n\r\nstatus: ${status_code##* }"
    }
    
    start_server() {
        while true; do
            response=$(create_response "$1")
            echo "$response" | nc -l -p 8080 -w 5
            sleep 0.1
        done
    }
    
    main() {
        interface="wg0"
        start_server "$interface"
    }
    
    main
