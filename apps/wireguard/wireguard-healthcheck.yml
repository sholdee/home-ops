apiVersion: v1
kind: ConfigMap
metadata:
  name: wg-healthcheck
  namespace: wireguard
data:
  healthcheck.sh: |
    #!/bin/sh
    
    is_link_up() {
        [ -f "/sys/class/net/$1/carrier" ] && [ "$(cat "/sys/class/net/$1/carrier")" = "1" ]
    }
    
    create_response() {
        if is_link_up "$1"; then
            echo -e "HTTP/1.1 200 OK\r\nContent-Type: text/plain\r\nContent-Length: 10\r\nConnection: close\r\n\r\nstatus: OK\n"
        else
            echo -e "HTTP/1.1 503 Service Unavailable\r\nContent-Type: text/plain\r\nContent-Length: 10\r\nConnection: close\r\n\r\nstatus: KO\n"
        fi
    }
    
    start_server() {
        local interface="$1"
        local port=8080
        local timeout=5
    
        while true; do
            response=$(create_response "$interface")
            echo "$response" | nc -l -p $port -w $timeout
            sleep 0.1
        done
    }
    
    main() {
        interface="wg0"
        start_server "$interface"
    }
    
    main
