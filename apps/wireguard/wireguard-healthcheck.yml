apiVersion: v1
kind: ConfigMap
metadata:
  name: wg-healthcheck
  namespace: wireguard
data:
  healthcheck.sh: |
    #!/bin/sh
    
    is_link_up() {
        if [ -f "/sys/class/net/$1/carrier" ]; then
            carrier=$(cat "/sys/class/net/$1/carrier")
            if [ "$carrier" = "1" ]; then
                return 0
            fi
        fi
        return 1
    }
    
    start_server() {
        interface="wg0"
        echo "Starting healthcheck server..."
        while true; do
            { 
                echo -ne "HTTP/1.1 200 OK\r\nContent-Type: text/plain\r\n\r\nstatus: OK\n";
            } | nc -l -p 8080 -w 1 > /dev/null 2>&1 &
            while is_link_up "$interface"; do
                sleep 1
            done
            echo -ne "HTTP/1.1 503 Service Unavailable\r\nContent-Type: text/plain\r\n\r\nstatus: KO\n";
        done
    }
    
    main() {
        echo "Starting healthcheck script..."
        start_server
    }
    
    main
