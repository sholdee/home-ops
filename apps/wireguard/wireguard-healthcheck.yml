apiVersion: v1
kind: ConfigMap
metadata:
  name: wireguard-entrypoint
  namespace: wireguard
data:
  entrypoint.sh: |
    #!/bin/sh
    
    check_interface() {
        [ -e "/sys/class/net/$1/carrier" ] && [ "$(cat /sys/class/net/$1/carrier)" = "1" ]
    }
    
    healthcheck_handler() {
        if check_interface wg0; then
            echo -e "HTTP/1.1 200 OK\r\nContent-Length: 2\r\n\r\nOK"
        else
            echo -e "HTTP/1.1 503 Service Unavailable\r\nContent-Length: 2\r\n\r\nKO"
        fi
    }
    
    start_healthcheck_server() {
        while true; do
            echo '#!/bin/sh
            check_interface() {
                [ -e "/sys/class/net/$1/carrier" ] && [ "$(cat /sys/class/net/$1/carrier)" = "1" ]
            }
            healthcheck_handler() {
                if check_interface wg0; then
                    echo -e "HTTP/1.1 200 OK\r\nContent-Length: 2\r\n\r\nOK"
                else
                    echo -e "HTTP/1.1 503 Service Unavailable\r\nContent-Length: 2\r\n\r\nKO"
                fi
            }
            healthcheck_handler' | nc -l -p 8080 -e /bin/sh
        done
    }
    
    finish () {
        wg-quick down wg0
        exit 0
    }
    trap finish TERM INT QUIT
    
    wg-quick up /etc/wireguard/wg0.conf
    
    # Start the healthcheck server
    start_healthcheck_server &
    
    # Wait for all background processes
    wait
