apiVersion: v1
kind: ConfigMap
metadata:
  name: wireguard-entrypoint
  namespace: wireguard
data:
  entrypoint.sh: |
    #!/bin/sh
    
    check_interface() {
        [ -e "/sys/class/net/$1/carrier" ] && [ "$(cat /sys/class/net/$1/carrier)" = "1" ]
    }
    
    healthcheck_handler() {
        if check_interface wg0; then
            printf "HTTP/1.1 200 OK\r\nContent-Type: text/plain\r\nContent-Length: 2\r\nConnection: close\r\n\r\nOK"
        else
            printf "HTTP/1.1 503 Service Unavailable\r\nContent-Type: text/plain\r\nContent-Length: 2\r\nConnection: close\r\n\r\nKO"
        fi
    }
    
    start_healthcheck_server() {
        while true; do
            { echo "Waiting for connection" >&2; nc -l -p 8080; } | while read line; do
                echo "Received: $line" >&2
                if echo "$line" | grep -q "^GET"; then
                    echo "Processing request" >&2
                    # Read and discard headers
                    while read header && [ -n "$header" ]; do
                        echo "Header: $header" >&2
                    done
                    healthcheck_handler
                    echo "Response sent" >&2
                    break
                fi
            done
        done
    }
    
    finish () {
        wg-quick down wg0
        exit 0
    }
    trap finish TERM INT QUIT
    
    wg-quick up /etc/wireguard/wg0.conf
    
    # Start the healthcheck server
    start_healthcheck_server &
    
    # Wait for all background processes
    wait
