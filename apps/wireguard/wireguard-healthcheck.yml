apiVersion: v1
kind: ConfigMap
metadata:
  name: wireguard-entrypoint
  namespace: wireguard
data:
  entrypoint.sh: |
    #!/bin/sh
    
    check_interface() {
        [ -e "/sys/class/net/$1/carrier" ] && [ "$(cat /sys/class/net/$1/carrier)" = "1" ]
    }
    
    healthcheck_handler() {
        if check_interface wg0; then
            echo -e "HTTP/1.1 200 OK\r\nContent-Length: 2\r\n\r\nOK"
        else
            echo -e "HTTP/1.1 503 Service Unavailable\r\nContent-Length: 2\r\n\r\nKO"
        fi
    }
    
    start_healthcheck_server() {
        while true; do
            nc -l -p 8080 -e /bin/sh -c 'healthcheck_handler'
        done
    }
    
    finish () {
        wg-quick down wg0
        exit 0
    }
    trap finish SIGTERM SIGINT SIGQUIT
    
    wg-quick up /etc/wireguard/wg0.conf
    
    # Start the healthcheck server
    start_healthcheck_server &
    
    # Infinite sleep
    sleep infinity &
    wait $!
