apiVersion: v1
kind: ConfigMap
metadata:
  name: wireguard-healthcheck
  namespace: wireguard
data:
  healthcheck.sh: |
    #!/bin/bash
    DEVICE=${DEVICE:-wg0}
    PORT=${PORT:-8080}

    check_wg() {
        ip link show $DEVICE up >/dev/null 2>&1
    }

    while true; do
        if check_wg; then
            status="healthy"
            code="200 OK"
        else
            status="unhealthy"
            code="503 Service Unavailable"
        fi
        (echo -e "HTTP/1.1 $code\r\nContent-Type: text/plain\r\n\r\n$status" && sleep 1) | nc -l -p $PORT
    done
