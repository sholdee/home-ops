apiVersion: v1
kind: ConfigMap
metadata:
  name: wireguard-entrypoint
  namespace: wireguard
data:
  entrypoint.sh: |
    #!/bin/sh
    
    check_interface() {
      [ -e "/sys/class/net/$1/carrier" ] && [ "$(cat /sys/class/net/$1/carrier)" = "1" ]
    }
    
    healthcheck_handler() {
      if check_interface wg0; then
        cat << EOF
    HTTP/1.1 200 OK
    Content-Type: text/plain
    Content-Length: 2
    Connection: close
    
    OK
    EOF
      else
        cat << EOF
    HTTP/1.1 503 Service Unavailable
    Content-Type: text/plain
    Content-Length: 2
    Connection: close
    
    KO
    EOF
      fi
    }
    
    start_healthcheck_server() {
      while true; do
        echo "Waiting for connection" >&2
        nc -l -p 8080 -w 5 | {
          read request
          echo "Received: $request" >&2
          if echo "$request" | grep -q "^GET"; then
            echo "Processing request" >&2
            # Read and discard headers
            while read header && [ -n "$header" ]; do
              echo "Header: $header" >&2
            done
            healthcheck_handler
            echo "Response sent" >&2
          fi
        }
        sleep 0.1  # Small delay to ensure response is sent
      done
    }
    
    finish() {
      wg-quick down wg0
      exit 0
    }
    trap finish TERM INT QUIT
    
    wg-quick up /etc/wireguard/wg0.conf
    
    # Start the healthcheck server
    start_healthcheck_server &
    
    # Wait for all background processes
    wait
