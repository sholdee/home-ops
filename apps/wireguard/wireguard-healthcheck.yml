apiVersion: v1
kind: ConfigMap
metadata:
  name: wg-healthcheck
  namespace: wireguard
data:
  healthcheck.sh: |
    #!/bin/sh
    
    is_link_up() {
        if [ -f "/sys/class/net/$1/carrier" ]; then
            carrier=$(cat "/sys/class/net/$1/carrier")
            if [ "$carrier" = "1" ]; then
                return 0
            fi
        fi
        return 1
    }
    
    return_status_code() {
        is_link_up "$1"
        if [ $? -eq 0 ]; then
            echo "200 OK"
        else
            echo "503 KO"
        fi
    }
    
    create_response() {
        status_code=$(return_status_code "$1")
        echo -e "HTTP/1.1 ${status_code%% *}\r\nContent-Type: text/plain\r\n\r\nstatus: ${status_code##* }"
    }
    
    start_server() {
        interface="wg0"
        echo "Starting healthcheck server..."
        while true; do
            echo "Waiting for connection..."
            { create_response "$interface"; } | nc -l -p 8080
            echo "Served a request..."
        done
    }
    
    main() {
        echo "Starting healthcheck script..."
        start_server
    }
    
    main
