apiVersion: v1
kind: ConfigMap
metadata:
  name: wg-healthcheck
  namespace: wireguard
data:
  healthcheck.sh: |
    #!/bin/sh
    
    start_server() {
        interface="wg0"
        echo "Starting healthcheck server..."
        while true; do
            { echo -ne "HTTP/1.1 200 OK\r\nContent-Type: text/plain\r\n\r\nstatus: OK" | nc -lk -p 8080 -e sh -c "
                is_link_up() {
                    if [ -f \"/sys/class/net/$interface/carrier\" ]; then
                        carrier=\$(cat \"/sys/class/net/$interface/carrier\")
                        if [ \"\$carrier\" = \"1\" ]; then
                            return 0
                        fi
                    fi
                    return 1
                }
                return_status_code() {
                    is_link_up \"$interface\"
                    if [ \$? -eq 0 ]; then
                        echo \"200 OK\"
                    else
                        echo \"503 KO\"
                    fi
                }
                status_code=\$(return_status_code \"$interface\")
                echo -e \"HTTP/1.1 \${status_code%% *}\r\nContent-Type: text/plain\r\n\r\nstatus: \${status_code##* }\"
            "; } 
        done
    }
    
    main() {
        echo "Starting healthcheck script..."
        start_server
    }
    
    # Execute the main function
    main
