apiVersion: apps/v1
kind: Deployment
metadata:
  name: wireguard
  namespace: wireguard
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  replicas: 3
  selector:
    matchLabels:
      app: wireguard
  template:
    metadata:
      labels:
        app: wireguard
    spec:
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app: wireguard
      initContainers:
        - name: sysctls
          image: busybox:1.36.1
          command:
          - sh
          - -c
          - sysctl -w net.ipv4.ip_forward=1 && sysctl -w net.ipv4.conf.all.forwarding=1
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
            privileged: true
      containers:
        - name: wireguard
          image: sholdee/wireguard-go-docker:0.0.20230223@sha256:b6de1066870f7fc8780904d65e846d772fad707e217514626dfe3b495d33fc1a
          command:
          - sh
          - -c
          - "/entrypoint.sh"
          ports:
          - containerPort: 443
            protocol: UDP
            name: wireguard
          - containerPort: 8080
            protocol: TCP
            name: healthcheck
          env:
          - name: LOG_LEVEL
            value: info
          - name: ENABLE_HEALTHCHECK
            value: "true"
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
            privileged: true
          resources:
            requests:
              memory: 64Mi
              cpu: "10m"
            limits:
              memory: 256Mi
          volumeMounts:
          - name: secret
            mountPath: /etc/wireguard/wg0.conf
            subPath: wg0.conf
          livenessProbe: &probe
            httpGet:
              path: /
              port: healthcheck
          readinessProbe: *probe
      volumes:
      - name: secret
        secret:
          secretName: wg-secret
